#!/usr/bin/make -f

# $Id$

UPSTREAM_URL=http://proyectos.outlyer.net/nautilus-follow-symlink

dist: gen

# aclocal won't find libtool's m4, at least in debian, unless an
# extra include path is given, with libtoolize it is "." while
# whitout it is /usr/share/libtool/m4, altough it will fail
# on finding ltmain.sh

gen: check-gen-deps
	libtoolize
	intltoolize
	aclocal -I .
	autoconf
	autoheader
	automake --add-missing --foreign

# This rule serves as a replacement for which for systems in which it
# isn't installed
# Use: ./dist which-PROGNAME or
# a rule that depends on which-PROGNAME1, which-PROGNAME2, ...
which-%:
	@bash -c "type -p $*" || { \
		echo "*** Couldn't find $*, can't continue without"\
		     "all requirements">&2 ;\
		false ; \
	}

check-gen-deps: \
		which-libtoolize \
		which-intltoolize \
		which-aclocal \
		which-autoconf \
		which-autoheader \
		which-automake-1.9

help:
	@echo "This file is used to aid in the setup of the build"
	@echo "environment, there are the following available targets"
	@echo "(use ./dist TARGET):"
	@echo "    gen        (default) Create the required structure"
	@echo "    clean      Remove the files created by gen and by the build process"
	@echo "    update-po  Update the language files with new translation or moved "
	@echo "               string locations (note it also updates the meta-timestamp)"
	@echo "               so it can get funny issuing this command when using CVS/SVN"
	@echo "    regen      'clean' then 'gen'"
	@echo "    help       This very message"


update-po:
	cd po && intltool-update -p
	cd po && for file in *.po ; do \
		intltool-update --dist `basename $$file .po` ; \
	done

regen: clean gen

clean:
	make distclean || true
	make clean || true
	cd src && make clean || true
	#
	rm -rf autom4te.cache
	rm -f config.* depcomp install-sh missing src/config.h src/config.h.in
	rm -f aclocal.m4
	rm -f configure Makefile Makefile.in src/Makefile src/Makefile.in
	rm -f po/*.gmo po/Makefile po/Makefile.in po/POTFILES
	find . -name 'stamp-??' -exec rm {} \;
	# The following are moved thanks to Makefile.am (var DISTCLEANFILES)
	# (kept for situations in which make distclean fails)
	# Undo libtoolize
	rm -f libtool.m4 lt*.m4 ltmain.sh libtool
	# Undo intltoolize
	rm -f intltool*
	rm -f po/Makefile.in.in

package-source: clean
	if [ -d .svn ]; then echo "WARNING: Using SVN working copy" >&2 && sleep 2s ; fi
	cd ../ && tar zcvf `basename $$OLDPWD`.tar.gz \
			--label 'nautilus-follow-symlink <$(UPSTREAM_URL)>' \
			--totals \
			--group 0 \
			--owner 0 \
			--exclude='.svn' \
			--exclude='devel_docs' \
			--exclude='.*' \
			`basename $$OLDPWD`/
